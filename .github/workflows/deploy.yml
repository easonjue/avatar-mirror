name: Build and Deploy
on: [ push ]
permissions:
  contents: write
  pages: write
  id-token: write
jobs:
  build-and-deploy:
    concurrency: ci-${{ github.ref }}
    runs-on: ubuntu-latest
    steps:
    - name: Checkout ğŸ›ï¸
      uses: actions/checkout@v6
      with:
        fetch-depth: 0

    - name: Set up Node.js ğŸŸ¢
      uses: actions/setup-node@v4
      with:
        node-version: 20
        # å…ˆä¸ç¼“å­˜ pnpmï¼ˆé¿å…æŸ¥æ‰¾æœªå®‰è£…çš„ pnpmï¼‰ï¼Œåç»­æ‰‹åŠ¨ç¼“å­˜
        cache: ''

    - name: æ ¡éªŒå¹¶å®‰è£… pnpm ğŸ“¦
      run: |
        # 1. æ ¡éªŒ pnpm æ˜¯å¦å­˜åœ¨ï¼ˆè¿”å› 0 åˆ™å­˜åœ¨ï¼Œé 0 åˆ™å®‰è£…ï¼‰
        if ! command -v pnpm &> /dev/null; then
          echo "pnpm æœªå®‰è£…ï¼Œå¼€å§‹å®‰è£…..."
          # å®˜æ–¹æ¨èçš„å®‰è£…æ–¹å¼ï¼ˆæ¯” npm install -g æ›´ç¨³å®šï¼‰
          curl -fsSL https://get.pnpm.io/install.sh | sh -
          # å°† pnpm åŠ å…¥ç¯å¢ƒå˜é‡ï¼ˆå…³é”®ï¼å¦åˆ™åç»­å‘½ä»¤æ‰¾ä¸åˆ° pnpmï¼‰
          echo "$HOME/.local/share/pnpm" >> $GITHUB_PATH
          echo "$HOME/.pnpm-store" >> $GITHUB_PATH
        else
          echo "pnpm å·²å®‰è£…ï¼Œç‰ˆæœ¬ï¼š$(pnpm --version)"
        fi

    - name: ç¼“å­˜ pnpm ä¾èµ– ğŸš€
      uses: actions/cache@v3
      with:
        # pnpm ä¾èµ–ç¼“å­˜è·¯å¾„ï¼ˆä¸åŒç³»ç»Ÿè·¯å¾„ä¸€è‡´ï¼‰
        path: ~/.pnpm-store
        # ç¼“å­˜å¯†é’¥ï¼ˆé”æ–‡ä»¶å˜åŒ–æ—¶é‡æ–°ç¼“å­˜ï¼‰
        key: ${{ runner.os }}-pnpm-${{ hashFiles('**/pnpm-lock.yaml') }}
        # å›é€€ç¼“å­˜ï¼ˆé”æ–‡ä»¶æœªå˜æ—¶å¤ç”¨æ—§ç¼“å­˜ï¼‰
        restore-keys: |
          ${{ runner.os }}-pnpm-

    - name: å®‰è£…é¡¹ç›®ä¾èµ– ğŸ”§
      run: |
        # éªŒè¯ pnpm ç‰ˆæœ¬ï¼ˆå¯é€‰ï¼Œä¾¿äºè°ƒè¯•ï¼‰
        pnpm --version
        # ä¸¥æ ¼å®‰è£…ä¾èµ–
        pnpm install --frozen-lockfile
      env:
        VITE_GITHUB_REPO: ${{ github.event.repository.name }}

    - name: æ„å»ºé¡¹ç›® ğŸ“¦
      run: pnpm run build

    - name: éƒ¨ç½²åˆ° GitHub Pages ğŸš€
      uses: JamesIves/github-pages-deploy-action@v4
      with:
        folder: dist
        branch: gh-pages
        clean: true
        force: true
        disable-jekyll: true
